---
title: "sm_regression"
author: "Daniel D. Sjoberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sm_regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

The `sm_regression()` function performs kernel weighted regression.  After the the model is specifed (`data = cancertx, method = "coxph", formula = Surv(time) ~ age`), an ancillary variable is specified (`weighting_var = "marker"`) and the model is estimated weighted on this variable.

## Example 

The function can be computationally intense on large data sets.  THe following code was run to get the example object `sm_regression_ex`.

```
sm_regression_ex =
  sjosmooth::sm_regression(
    data = cancertx,
    method = "coxph",
    formula = Surv(time) ~ age,
    weighting_var = "marker",
    newdata = dplyr::data_frame(marker = seq(7, 12, 0.5))
  )
```

The data in the `cancertx` data frame was simulated from a Cox regression model with linear predictor.  

$$
\textbf{X}\beta = 0.02 * age - 0.2 * marker
$$

In the model age and marker level are independent, and therefore, the univariate model is simply

$$
\textbf{X}\beta = 0.02 * age
$$

The beta coeffiicent is the same across all marker levels.  In the figure below, the solid black line is the estiamtes beta coefficient (with 95% CI), and the dashed line is the true value. 

```{r remedy001, messages = F}
library(sjosmooth)
library(survival)
library(dplyr)
library(ggplot2)
# loading data and example results from sjosmooth github page
load(url("https://github.com/ddsjoberg/sjosmooth/blob/master/examples/sm_regression_ex1.rda?raw=true"))
load(url("https://github.com/ddsjoberg/sjosmooth/blob/master/examples/cancertx.rda?raw=true"))

# plotting regression model coefficient by marker level
plot_data =
  sm_regression_ex1 %>%
  mutate(
    age.coef = purrr::map_dbl(model_obj, ~coef(.x)),
    age.ci = purrr::map(model_obj, ~confint(.x) %>% as_data_frame())
  ) %>%
  select(newdata, age.coef, age.ci) %>%
  tidyr::unnest(age.ci, newdata)

ggplot(plot_data, aes(x = marker, y = age.coef)) +
  geom_line() +
  geom_ribbon(aes(ymin = `2.5 %`, ymax = `97.5 %`), alpha = 0.3) +
  geom_hline(aes(yintercept = 0.02), linetype = "dashed") +
  scale_y_continuous(limits = c(0, 0.04)) +
  labs(
    y = "beta "
  )
```
